<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.care.user.mapper.BookingMapper">

<insert id="parentsInsert" parameterType="com.care.user.dto.UserParentsDTO">

    <selectKey resultType="int" keyProperty="pno" order="AFTER">
       select max(p_no) from parents_g4
    </selectKey>
     
    	insert into parents_g4 (p_name, p_phone, p_sub_phone)
	values(#{pname} , #{pphone}, #{psubPhone} )

	
</insert>

 
 <select id="selectTeacher" resultType="com.care.user.dto.BookingTeacherDTO" parameterType="com.care.user.dto.BookingTeacherDTO">
 	select 
		 	bo_addr as  boAddr, 
		 	bo_date as boDate, 
		 	bo_time as boTime, 
		 	teacher_g4.t_no as tno,
		    t_name as tname,
            t_addr as taddr,
            t_info as tinfo,
            t_photo as tphoto
	 from teacher_g4 
	 join booking_g4 
		on booking_g4.t_no = teacher_g4.t_no		
	where teacher_g4.t_addr = #{boAddr}
	and booking_g4.bo_date =#{boDate}
	and booking_g4.bo_time not in (#{boTime});
	
	
 </select>


<insert id="bookingInsert" parameterType="com.care.user.dto.BookingDTO">
	   
     insert into booking_g4(p_no, t_no, bo_addr, bo_date, bo_time, bo_hour, bo_road_name, bo_remarks, bo_cancel, bo_payment)
   		values((select max(p_no) from parents_g4 ), 3 , #{boAddr}, #{boDate}, #{boTime}, #{boHour}, concat(#{boRoadName} , #{boRoadNameDetail}),
  		  	#{boRemarks}, 0 , 0)

</insert>



<select id="bookingCheck" parameterType="com.care.user.dto.BookingParentsDTO"  resultType="com.care.user.dto.BookingParentsDTO">
 <![CDATA[	select   *                              			
			from (                                  			
	       select @rownum:=@rownum+1 as rnum, A.*      
		       from (                          			
					select 
					booking_g4.p_no as pno 
					, p_name as pname
					, p_phone as pphone
					, t_no as tNo 
					, bo_addr as boAddr 
					, bo_date as boDate 
					, bo_time as boTime 
					, bo_hour as boHour
					, bo_road_name as boRoadName
					, bo_remarks as boRemarks
					, bo_cancel as boCancel 
					, bo_payment as boPayment
				from booking_g4
				join parents_g4 
				on booking_g4.p_no = parents_g4.p_no
				where 
					p_name = #{pname}
					and p_phone=#{pphone}
					order by pno
	               )A, (select @rownum:=0) R  
	       ) B                                
	 where rnum>= #{startrow}  and rnum<=#{endrow}
 ]]>
	 
</select>

<delete id="bookingDelete" parameterType="com.care.user.dto.BookingParentsDTO">
	delete booking_g4
	from booking_g4
	join parents_g4 
	on booking_g4.p_no = parents_g4.p_no
	where booking_g4.p_no = #{pno}
	 
</delete>

<select id="getMyTotalCount" parameterType="com.care.user.dto.BookingParentsDTO"  resultType="int">
	select count(*) 
	from  booking_g4
	join parents_g4 
	on booking_g4.p_no = parents_g4.p_no
	where 
		p_name = #{pname}
	and p_phone=#{pphone}
</select>



</mapper>